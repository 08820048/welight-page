# HTTP 重定向到 HTTPS
server {
    listen 80;
    server_name ilikexff.cn www.ilikexff.cn admin.ilikexff.cn waer.ltd www.waer.ltd;
    return 301 https://$server_name$request_uri;
}

# 主站 HTTPS (ilikexff.cn)
server {
    listen 443 ssl http2;
    server_name ilikexff.cn www.ilikexff.cn;

    # SSL 证书配置
    ssl_certificate /etc/letsencrypt/live/ilikexff.cn/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/ilikexff.cn/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # 文件上传大小限制
    client_max_body_size 10M;

    # JavaScript 和 CSS 文件的正确 MIME 类型和缓存
    location ~* \.(js|mjs)$ {
        root /var/www/apexblog/frontend/dist;
        add_header Content-Type application/javascript;
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    location ~* \.css$ {
        root /var/www/apexblog/frontend/dist;
        add_header Content-Type text/css;
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # 其他静态资源缓存
    location ~* \.(png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp)$ {
        root /var/www/apexblog/frontend/dist;
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # ads.txt 文件特殊处理
    location = /ads.txt {
        root /var/www/apexblog/frontend/dist;
        add_header Content-Type text/plain;
        expires 1d;
        try_files $uri =404;
    }

    # 前端静态文件 - 必须放在最后，作为默认处理
    location / {
        root /var/www/apexblog/frontend/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # API 代理到后端
    location /api/ {
        proxy_pass http://localhost:8888/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # 文件上传相关配置
        client_max_body_size 10M;
        proxy_request_buffering off;
        proxy_buffering off;

        # 超时设置
        proxy_read_timeout 300s;
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
    }

    # 日志配置
    access_log /var/log/nginx/apexblog.access.log;
    error_log /var/log/nginx/apexblog.error.log;
}

# 管理后台 HTTPS (admin.ilikexff.cn)
server {
    listen 443 ssl http2;
    server_name admin.ilikexff.cn;

    # SSL 证书配置
    ssl_certificate /etc/letsencrypt/live/admin.ilikexff.cn/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/admin.ilikexff.cn/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # 文件上传大小限制
    client_max_body_size 10M;

    # JavaScript 和 CSS 文件的正确 MIME 类型和缓存
    location ~* \.(js|mjs)$ {
        root /var/www/apexblog/admin/dist;
        add_header Content-Type application/javascript;
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    location ~* \.css$ {
        root /var/www/apexblog/admin/dist;
        add_header Content-Type text/css;
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # 其他静态资源缓存
    location ~* \.(png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp)$ {
        root /var/www/apexblog/admin/dist;
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # 管理后台静态文件 - 必须放在最后，作为默认处理
    location / {
        root /var/www/apexblog/admin/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # API 代理到后端
    location /api/ {
        proxy_pass http://localhost:8888/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # 文件上传相关配置
        client_max_body_size 10M;
        proxy_request_buffering off;
        proxy_buffering off;

        # 超时设置
        proxy_read_timeout 300s;
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
    }

    # 日志配置
    access_log /var/log/nginx/admin.access.log;
    error_log /var/log/nginx/admin.error.log;
}

# 新的 Vue 项目 HTTPS (waer.ltd)
server {
    listen 443 ssl http2;
    server_name waer.ltd www.waer.ltd;

    # SSL 证书配置
    ssl_certificate /etc/letsencrypt/live/waer.ltd/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/waer.ltd/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # 安全头
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;

    # 文件上传大小限制（针对大文件下载）
    client_max_body_size 100M;

    # Welight 编辑器 - 处理 /wl 重定向到 /wl/
    location = /wl {
        return 301 $scheme://$server_name/wl/;
    }

    # Welight 编辑器 - 所有 /wl/ 请求
    location /wl/ {
        alias /var/www/waer/welight-editor/;
        index index.html;

        # 添加调试头信息
        add_header X-Debug-Path $uri always;
        add_header X-Debug-Root /var/www/waer/welight-editor/ always;

        # 优先尝试文件，然后尝试目录，最后回退到 index.html
        try_files $uri $uri/ /wl/index.html;

        # 设置静态资源的缓存和 MIME 类型
        location ~* \.(js|mjs)$ {
            add_header X-Debug-Type "JavaScript" always;
            expires 1y;
            add_header Cache-Control "public, immutable";
            add_header Content-Type application/javascript;
        }

        location ~* \.css$ {
            add_header X-Debug-Type "CSS" always;
            expires 1y;
            add_header Cache-Control "public, immutable";
            add_header Content-Type text/css;
        }

        location ~* \.(png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp)$ {
            add_header X-Debug-Type "Static-Asset" always;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # 主站 JavaScript 和 CSS 文件的正确 MIME 类型和缓存
    location ~* \.(js|mjs)$ {
        root /var/www/waer/dist;
        add_header Content-Type application/javascript;
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    location ~* \.css$ {
        root /var/www/waer/dist;
        add_header Content-Type text/css;
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # 主站其他静态资源缓存
    location ~* \.(png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp)$ {
        root /var/www/waer/dist;
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # 下载文件的 location 块
    location /downloads/ {
        root /var/www/waer;
        autoindex off; # 禁用目录列表以提高安全性
        try_files $uri $uri/ =404;

        # 设置正确的 MIME 类型
        location ~* \.exe$ {
            add_header Content-Disposition "attachment; filename=$1";
            default_type application/octet-stream;
        }
        location ~* \.dmg$ {
            add_header Content-Disposition "attachment; filename=$1";
            default_type application/octet-stream;
        }
        location ~* \.(deb|rpm|AppImage)$ {
            add_header Content-Disposition "attachment; filename=$1";
            default_type application/octet-stream;
        }
         location ~* \.msi$ {
            add_header Content-Disposition "attachment; filename=$1";
            default_type application/octet-stream;
        }

        # 缓存控制
        expires 1d;
        add_header Cache-Control "public";
    }

    # Vue 项目静态文件 - 必须放在最后，作为默认处理
    location / {
        root /var/www/waer/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # 日志配置
    access_log /var/log/nginx/waer.access.log;
    error_log /var/log/nginx/waer.error.log;
}
